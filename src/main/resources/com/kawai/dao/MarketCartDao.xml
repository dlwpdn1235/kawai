<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kawai.dao.MarketCartDao">

	<delete id="marketCartDelete" parameterType="marketCart">
		delete from mcart 
		where mCart_id = #{MCart_id} 
		AND user_id=#{user_id}
	</delete>

	<insert parameterType="MarketCart" id="marketCartInsert">
		insert into mcart(mCount ,market_id,user_id)
		values (1,#{market_id},#{user_id})
	</insert>
	<resultMap id="marketCart" type="MarketCart">
		<id property="mCart_id"         column="mCart_id" /> <!-- property : MemberVO -->
		<result property="mCount"     column="mCount" /> <!-- column : db컬럼명 -->
		<result property="mCartDate"  column="mCartDate" />
		<result property="market_id"  column="market_id" />
		<result property="user_id"    column="user_id" />
 		<association property="market"     resultMap="market" />
 	</resultMap>

	<resultMap id="market" type="Market">
		<id column="market_id" property="market_id" />
		<!-- property : MemberVO -->
		<result column="market_id" property="market_id" />
		<!-- column : db컬럼명 -->
		<result column="mTitle" property="mTitle" />
		<result column="mContent" property="mContent" />
		<result column="mIp" property="mIp" />
		<result column="mPrice" property="mPrice" />
		<result column="mDate" property="mDate" />
		<result column="user_id" property="user_id" />
		<association property="bookinfo"
			resultMap="commDtoBookinfo" />

	</resultMap>
	<resultMap id="commDtoBookinfo" type="CommDtoBookinfo">
		<id property="bookinfo_id" column="bookinfo_id" /> <!-- property : MemberVO -->
		<result property="book_title" column="book_title" />
		<result property="book_description" column="book_description" />
		<result property="book_author" column="book_author" />
		<result property="book_publisher" column="book_publisher" />
		<result property="book_image" column="book_image" />
		<result property="book_pubdate" column="book_pubdate" />
	</resultMap>
	<select parameterType="String" id="marketCartList"
		resultMap="marketCart">
		SELECT c.*, b.*, m.*
		FROM mCart c
		LEFT JOIN market m ON c.market_id = m.market_id
		LEFT JOIN bookinfo b ON b.bookinfo_id = m.bookinfo_id
		WHERE m.user_id = #{user_id}
	</select>

	<update parameterType="MarketCart" id="marketCartUpdate">
		update mcart set
		user_id=#{user_id} , market_id=#{market_id} , mCartDate = now()
		where
		mcart_id = market_id
	</update>

	<!-- <select id="marketCartInsertList" parameterType="MarketCart">select</select> -->

	<update id="marketCartCountUpdate">
		UPDATE mcart AS t1
		INNER JOIN (
		SELECT user_id, market_id, COUNT(*) AS count
		FROM mcart
		WHERE user_id = #{user_id} AND market_id = #{market_id}
		GROUP BY user_id, market_id
		) AS t2 ON t1.user_id = t2.user_id AND t1.market_id = t2.market_id
		SET t1.mcount = t2.count
		WHERE t1.user_id = #{user_id} AND t1.market_id = #{market_id}
	</update>
	
	<select id="marketCartCount" parameterType="int">
		
	</select>

</mapper>