<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kawai.dao.MarketDao">

	<insert parameterType="MarketPay" id="marketInsert">insert into
		market(mTitle,mContent,mIp,mPrice,user_id,bookinfo_id)values(#{mTitle},#{mContent},#{mIp},#{mPrice},#{user_id},#{bookinfo.bookinfo_id})
	</insert>

	<update parameterType="MarketPay" id="marketUpdate">update market set
		mTitle=#{mTitle} , mContent=#{mContent} ,
		bookInfo_id=#{bookInfo.bookinfo_id} wheremarket_id=#{market_id}
	</update>

	<resultMap id="market" type="Market">
		<id column="market_id" property="market_id" />
		<!-- property : MemberVO -->
		<result column="market_id" property="market_id" />
		<!-- column : db컬럼명 -->
		<result column="mTitle" property="mTitle" />
		<result column="mContent" property="mContent" />
		<result column="mIp" property="mIp" />
		<result column="mPrice" property="mPrice" />
		<result column="mDate" property="mDate" />
		<result column="user_id" property="user_id" />
		<association property="bookinfo"
			resultMap="commDtoBookinfo" />

	</resultMap>
	<resultMap id="commDtoBookinfo" type="CommDtoBookinfo">
		<id column="bookinfo_id" property="bookinfo_id" />
		<!-- property : MemberVO -->
		<result column="book_title" property="book_title" />
		<result column="book_description" property="book_description" />
		<result column="book_author" property="book_author" />
		<result column="book_publisher" property="book_publisher" />
		<result column="book_image" property="book_image" />
		<result column="book_pubdate" property="book_pubdate" />
	</resultMap>

	<select parameterType="Market" id="marketRead"
		resultMap="market">
		SELECT a.market_id, a.user_id, a.mPrice, a.bookinfo_id,
		b.book_title, b.book_author, b.book_publisher, b.book_image,
		b.book_pubdate FROM market a LEFT JOIN bookinfo b ON a.bookinfo_id =
		b.bookinfo_id WHERE market_id = #{market_id} </select>
	<select parameterType="MarketPage" id="marketList"
		resultMap="market">
		select m.market_id, m.user_id, m.mPrice, m.bookinfo_id, bi.book_title,
		bi.book_author, bi.book_publisher, bi.book_image, bi.book_pubdate from
		market m left join bookinfo bi on m.bookinfo_id = bi.bookinfo_id
		<if test="marketSearch != 0 and marketSearchKeyWord != ''">
			<where>
				<choose>
					<when test="marketSearch == 1">m.mTitle = #{marketSearchKeyWord} </when>
					<when test="marketSearch == 2">inner join bookinfo bi on m.bookinfo_id =
						bi.bookinfo_id and bi.book_title = #{marketSearchKeyWord} </when>
					<when test="marketSearch == 3">inner join bookinfo bi on m.bookinfo_id =
						bi.bookinfo_id and bi.book_author = #{marketSearchKeyWord} </when>
					<when test="marketSearch == 4">inner join bookinfo bi on m.bookinfo_id =
						bi.bookinfo_id and bi.book_publisher = #{marketSearchKeyWord}
					</when>
				</choose>
			</where>
		</if>
		<choose>
			<when test="marketOption == 1">order by m.mDate desc </when>
			<when test="marketOption == 2">order by m.mPrice desc </when>
			<when test="marketOption == 3">order by m.mPrice asc </when>
			<otherwise>order by m.mDate desc </otherwise>
		</choose>
		<choose>
			<when test="marketListCount != 0">limit #{marketPageCount}, #{marketListCount} </when>
			<otherwise>limit #{marketPageCount}, 20 </otherwise>
		</choose>
	</select>

	<update parameterType="Market" id="marketCount">UPDATE mpay AS m JOIN (SELECT
		market_id, SUM(mPrice=#{mPrice}) AS total_price FROM marketGROUP BY
		market_id ) AS t ON m.market_id = t.market_id SET m.mPayCount=
		t.total_price; </update>

	<delete parameterType="Market" id="marketDelete">delete from market
		wheremarket_id =#{market_id} </delete>


</mapper>